name: Release

on:
  release:
    types: [created]

jobs:
  release:
    name: Release
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Build Binary
        run: make build

      - name: Create Homebrew Formula
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          # Create Homebrew formula
          cat > formula.rb <<EOF
          class Asc < Formula
            desc "A fast, AI-agent friendly CLI for App Store Connect"
            homepage "https://github.com/rudrankriyam/App-Store-Connect-CLI"
            url "https://github.com/rudrankriyam/App-Store-Connect-CLI/archive/refs/tags/v#{VERSION}.tar.gz"
            sha256 "$(shasum -a 256 asc | cut -d' ' -f1)"
            license "MIT"

            def install
              bin.install "asc"
            end

            test do
              assert_match "asc version", shell_output("#{bin}/asc --version").strip
            end
          EOF
          echo "formula.rb created"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: asc
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
